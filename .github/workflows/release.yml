name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump (major, minor, patch)"
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
        required: true

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: ${{ github.event.repository.default_branch }}
      MODULE_MANIFEST: SecretsExpirationMonitor/SecretsExpirationMonitor.psd1
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}
      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Bump version
        id: version
        env:
          VERSION_BUMP: ${{ inputs.version_bump }}
        run: |
          set -euo pipefail
          if [ ! -f VERSION ]; then
            echo "Error: VERSION file not found. Ensure the VERSION file exists in the repository root."
            exit 1
          fi
          current_version=$(sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' VERSION | tr -d '\n')
          if ! [[ "$current_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: VERSION file must contain semantic format X.Y.Z (found: $current_version)."
            exit 1
          fi
          IFS='.' read -r major minor patch <<< "$current_version"
          case "$VERSION_BUMP" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
            *) echo "Unknown bump: $VERSION_BUMP"; exit 1 ;;
          esac
          new_version="${major}.${minor}.${patch}"
          echo "$new_version" > VERSION
          NEW_VERSION="$new_version" python - <<'PY'
          import os
          import pathlib
          import re
          new_version = os.environ["NEW_VERSION"]
          path = pathlib.Path(os.environ["MODULE_MANIFEST"])
          if not path.exists():
              raise SystemExit(f"Error: Module manifest not found. Ensure {path} exists.")
          text = path.read_text()
          text, count = re.subn(r"(ModuleVersion\s*=\s*)'(\d+\.\d+\.\d+)'", rf"\1'{new_version}'", text)
          if count == 0:
              raise SystemExit(f"Error: ModuleVersion entry not found in module manifest. Ensure ModuleVersion is set in {path}.")
          path.write_text(text)
          PY
          echo "version=$new_version" >> "$GITHUB_OUTPUT"
      - name: Commit version bump
        run: |
          git add VERSION "${MODULE_MANIFEST}"
          git commit -m "Bump version to v${{ steps.version.outputs.version }}"
          for attempt in 1 2 3; do
            if git pull --rebase origin "${TARGET_BRANCH}"; then
              break
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "Error: Rebase failed after ${attempt} attempts. ${TARGET_BRANCH} may have diverged or have conflicts. Sync with ${TARGET_BRANCH}, resolve version conflicts in VERSION/manifest if needed, push, and re-run the release workflow."
              exit 1
            fi
            echo "Rebase failed (attempt ${attempt}). Retrying..."
            sleep 5
          done
          git fetch --tags origin
          if git ls-remote --exit-code --tags origin "v${{ steps.version.outputs.version }}" > /dev/null; then
            echo "Error: Tag v${{ steps.version.outputs.version }} already exists on ${TARGET_BRANCH}. Update version and re-run."
            exit 1
          fi
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "HEAD:${TARGET_BRANCH}"
          git push origin "v${{ steps.version.outputs.version }}"
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          generate_release_notes: true
