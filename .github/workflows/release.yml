name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump (major, minor, patch)"
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch
        required: true

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}
      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Bump version
        id: version
        env:
          VERSION_BUMP: ${{ inputs.version_bump }}
        run: |
          set -euo pipefail
          if [ ! -f VERSION ]; then
            echo "Error: VERSION file not found. Ensure the VERSION file exists in the repository root."
            exit 1
          fi
          current_version=$(tr -d ' \n' < VERSION)
          if ! [[ "$current_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: VERSION must be in semantic format X.Y.Z (found: $current_version)."
            exit 1
          fi
          IFS='.' read -r major minor patch <<< "$current_version"
          case "$VERSION_BUMP" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
            *) echo "Unknown bump: $VERSION_BUMP"; exit 1 ;;
          esac
          new_version="${major}.${minor}.${patch}"
          echo "$new_version" > VERSION
          NEW_VERSION="$new_version" python - <<'PY'
          import os
          import pathlib
          import re
          new_version = os.environ["NEW_VERSION"]
          path = pathlib.Path("SecretsExpirationMonitor/SecretsExpirationMonitor.psd1")
          if not path.exists():
              raise SystemExit("Error: Module manifest not found. Ensure SecretsExpirationMonitor/SecretsExpirationMonitor.psd1 exists.")
          text = path.read_text()
          text, count = re.subn(r"(ModuleVersion\s*=\s*)'(\d+\.\d+\.\d+)'", rf"\1'{new_version}'", text)
          if count == 0:
              raise SystemExit("Error: ModuleVersion entry not found in module manifest. Ensure ModuleVersion is set in SecretsExpirationMonitor.psd1.")
          path.write_text(text)
          PY
          echo "version=$new_version" >> "$GITHUB_OUTPUT"
      - name: Commit version bump
        run: |
          git add VERSION SecretsExpirationMonitor/SecretsExpirationMonitor.psd1
          git commit -m "Bump version to v${{ steps.version.outputs.version }}"
          git pull --rebase origin "${TARGET_BRANCH}" || {
            echo "Error: Rebase failed. ${TARGET_BRANCH} may have diverged or have conflicts. Cancel this run, pull latest changes locally, resolve conflicts, push, and re-run the release workflow."
            exit 1
          }
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "HEAD:${TARGET_BRANCH}"
          git push origin "v${{ steps.version.outputs.version }}"
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          generate_release_notes: true
